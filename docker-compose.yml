version: '3.8'

services:
  # PostgreSQL Database
  spiffworkflow-db:
    image: postgres:15-alpine
    container_name: spiffworkflow-db
    environment:
      POSTGRES_DB: spiffworkflow
      POSTGRES_USER: spiffworkflow
      POSTGRES_PASSWORD: spiffworkflow
    ports:
      - "5432:5432"
    volumes:
      - spiffworkflow-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U spiffworkflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spiffworkflow-network

  # Redis for caching and session management
  spiffworkflow-redis:
    image: redis:7-alpine
    container_name: spiffworkflow-redis
    ports:
      - "6379:6379"
    volumes:
      - spiffworkflow-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - spiffworkflow-network

  # SpiffWorkflow Backend API
  spiffworkflow-backend:
    image: ghcr.io/sartography/spiffworkflow-backend:latest
    container_name: spiffworkflow-backend
    depends_on:
      spiffworkflow-db:
        condition: service_healthy
      spiffworkflow-redis:
        condition: service_healthy
    environment:
      # Database configuration
      SPIFFWORKFLOW_BACKEND_DATABASE_URI: "postgresql://spiffworkflow:spiffworkflow@spiffworkflow-db:5432/spiffworkflow"

      # Redis configuration
      SPIFFWORKFLOW_BACKEND_REDIS_URI: "redis://spiffworkflow-redis:6379"

      # Application settings
      FLASK_APP: src/spiffworkflow_backend
      FLASK_ENV: development
      SPIFFWORKFLOW_BACKEND_ENV: local_development
      SPIFFWORKFLOW_BACKEND_URL: "http://localhost:7000"
      SPIFFWORKFLOW_BACKEND_PORT: "7000"

      # Frontend URL
      SPIFFWORKFLOW_BACKEND_URL_FOR_FRONTEND: "http://localhost:7001"

      # Authentication (using local development mode)
      SPIFFWORKFLOW_BACKEND_OPEN_ID_SERVER_URL: "http://localhost:7000/openid"
      SPIFFWORKFLOW_BACKEND_PERMISSIONS_FILE_NAME: "local_development.yml"

      # BPMN spec storage
      SPIFFWORKFLOW_BACKEND_BPMN_SPEC_ABSOLUTE_DIR: "/app/process_models"

      # Logging
      SPIFFWORKFLOW_BACKEND_LOG_LEVEL: "DEBUG"
    ports:
      - "7000:7000"
    volumes:
      - spiffworkflow-process-models:/app/process_models
      - spiffworkflow-backend-logs:/app/log
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/v1.0/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - spiffworkflow-network

  # SpiffWorkflow Frontend UI
  spiffworkflow-frontend:
    image: ghcr.io/sartography/spiffworkflow-frontend:latest
    container_name: spiffworkflow-frontend
    depends_on:
      - spiffworkflow-backend
    environment:
      # Backend API URL
      SPIFFWORKFLOW_FRONTEND_RUNTIME_CONFIG_API_URL: "http://localhost:7000"

      # Port configuration
      PORT: "7001"

      # Development mode
      NODE_ENV: development
    ports:
      - "7001:7001"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7001"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - spiffworkflow-network

volumes:
  spiffworkflow-db-data:
    driver: local
  spiffworkflow-redis-data:
    driver: local
  spiffworkflow-process-models:
    driver: local
  spiffworkflow-backend-logs:
    driver: local

networks:
  spiffworkflow-network:
    driver: bridge
